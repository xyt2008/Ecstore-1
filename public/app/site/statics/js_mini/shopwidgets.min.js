var DragDropPlus=new Class({Implements:[Options,Events],options:{},initialize:function(a,b,c){this.dragSelecterString=a;this.dropSelecterString=b;this.drags=$$(a);this.drops=$$(b);this.setOptions(c);if(this.drag_operate_box=$("drag_operate_box"))this.drag_operate_box.store("lock",!1),this.drag_handle_box=this.drag_operate_box.getElement(".drag_handle_box"),this.drag_rules=this.drag_operate_box.getElement(".drag_rules"),this.scrollFx=new Fx.Scroll(document,{fps:50,duration:200,link:"cancel"}),this.dobFx=
new Fx.Morph(this.drag_operate_box,{fps:50,duration:150,link:"cancel"}),this.dhbFx=new Fx.Morph(this.drag_handle_box,{fps:50,duration:150,link:"cancel"}),this.rsFx=new Fx.Morph(this.drag_rules,{fps:50,duration:150,link:"cancel"}),this.dragSign=$("drag_ghost_box").inject(document.body),this.fireEvent("onInit",this),this.initDOBBase(this.drops),this.initDrags(this.drags),this.initDrops(this.drops)},checkEmptyDropPanel:function(a){if(a&&a.hasClass(this.dropSelecterString.substring(1,this.dropSelecterString.length)))if(a.getElement(this.dragSelecterString))a.getElement(".empty_drop_box")&&
a.getElement(".empty_drop_box").destroy();else if(!a.getElement(".empty_drop_box")){var b=(new Element("div.empty_drop_box")).set("html",'&nbsp;<button type="button" class="btn btn-add-widgets"><span><span><i class="icon"></i>添加挂件</span></span></button>').inject(a);b.addEvent("click",function(a){this.fireEvent("add",[b],this)}.bind(this));this.dragmoveInstance&&(a.store("droppanel",!0),this.dragmoveInstance.droppables.include(a))}},dragLeave:function(){},dargInject:function(a,b){var c=this.dragging;
if(c){var d="inside";b.retrieve("droppanel")||(d=c.getAllPrevious().contains(b)?"before":"after");c.inject(b,d);this.checkEmptyDropPanel(a.retrieve("droped"));this.checkEmptyDropPanel(b);a.store("droped",b);this.dragSign.setStyles(c.getCoordinates())}},getDropables:function(){var a=this.dragging;return Array.from(this.drags).erase(a).combine(this.drops.filter(function(a){if(a.getElement(this.dragSelecterString))return a.store("droppanel",!1),!1;a.store("droppanel",!0);return!0}.bind(this)))},initDOBBase:function(a){var b=
this.drag_operate_box,c=this.drag_handle_box,d=this;a&&(c.getElements(".btn-up-slot,.btn-down-slot").addEvent("click",function(a){var c=b.retrieve("drag"),k=c.getParent().getChildren(),g=c[this.hasClass("btn-up-slot")?"getPrevious":"getNext"]();if(g){a.stop();var l=(new Fx.Sort(k,{duration:250,mode:"vertical",link:"chain",onComplete:function(){l.rearrangeDOM();document.body.fireEvent("mouseover",{target:c});d.fireEvent("upDown",[b.retrieve("drag")],d)}})).swap(c,g)}}),c.getElement(".btn-edit-widgets").addEvent("click",
function(a){a.stop();this.fireEvent("edit",[b.retrieve("drag")],this)}.bind(this)),b.addEvent("dblclick",function(a){a.stop();this.fireEvent("edit",[b.retrieve("drag")],this)}.bind(this)),c.addEvent("dblclick",function(a){a.stop()}.bind(this)),c.getElement(".btn-del-widgets").addEvent("click",function(a){a.stop();this.fireEvent("delete",[b.retrieve("drag")],this)}.bind(this)),c.getElements("li").addEvent("click",function(a){a.stop();this.fireEvent("add",[b.retrieve("drag"),$(a.target)],this)}.bind(this)))},
initDrags:function(a){var b=this,c=this.drag_operate_box,d=this.drag_handle_box,h=this.drag_rules,e;document.body.addEvents({mouseover:function(h){h=$(h.target);var g=h.getParent(b.dragSelecterString);!g&&!h.hasClass(b.dragSelecterString.substr(1))||c.retrieve("lock")||(g=g||h,b.fireEvent("initDrags",[g,a],b),d.set("title",g.get("title")||"&nbsp;"),c.setStyle("visibility","visible"),c.store("drag",g),e=g.getCoordinates(),e=Object.append(e,{top:e.top-d.getSize().y,height:e.height-c.getPatch().y+d.getSize().y,
width:e.width-c.getPatch().x}),delete e.bottom,delete e.right,h=235+c.getPatch().x,b.dhbFx.start({left:e.left+h+c.getStyle("border-left").toInt()>document.body.getSize().x&&!Browser.ie6?e.width-h:0}),b.dobFx.start(e),d.getElements(".btn-up-slot,.btn-down-slot").removeClass("disabled"),g.getPrevious()||d.getElement(".btn-up-slot").addClass("disabled"),g.getNext()||d.getElement(".btn-down-slot").addClass("disabled"))}});d.addEvents({mouseenter:function(a){e&&50<=e.width&&(h.show().getElement(".drag_annotation").setStyle("width",
e.width-2*h.getElement(".drag_left_arrow").getSize().x).getElement("em").set("text",e.width+c.getPatch().x+"px"),b.rsFx.cancel(),b.rsFx.start({height:20,"line-height":20}))},mouseleave:function(a){e&&50<=e.width&&(b.rsFx.cancel(),b.rsFx.start({height:0,"line-height":0}))}});window.addEvent("domready",function(){a.each(function(a){b.checkEmptyDrag(a);a.getElements("form").removeEvents().addEvent("submit",function(a){a.stop()});a.getElements("a").removeEvents().addEvent("click",function(a){a.stop()})})})},
checkEmptyDrag:function(a){a.getOuterSize().y||this.fireEvent("emptyDrag",[a],this)},initDrops:function(a){a.each(function(b,c){this.checkEmptyDropPanel(b);this.fireEvent("initDrops",[b,a],this)},this)}});var Widgets=new Class({Extends:DragDropPlus,initialize:function(a,b,c){this.parent(a,b,c);this.drags.each(function(a){a.getProperty("ishtml")&&a.getElement(".content-html").set("html",a.getElement(".content-textarea").get("value"))})},inject:function(a,b){this.addWidget(this.curEl,a,b||this.theme)},ghostDrop:function(a,b){a="string"===typeOf(a)?JSON.decode(a):a;this.drag_operate_box.setStyle("visibility","hidden").store("lock",!0);$("tempDropBox")&&$("tempDropBox").destroy();this.tempDropBox=(new Element("div",
{id:"tempDropBox"})).inject(document.body);try{var c=this.drag_operate_box.retrieve("drag");this.tempDropBox.empty();this.addWidget(c,a,b);this.drag_operate_box.store("lock",!1)}catch(d){alert(JSON.encode(d))}document.body.addEvent("contextmenu",function(a){a.stop();$("tempDropBox")&&$("tempDropBox").destroy();this.drag_operate_box.store("lock",!1);document.body.removeEvent("contextmenu",arguments.callee)}.bind(this))},copyWidgets:function(a){},addWidget:function(a,b,c){this.curdialog=new top.Dialog(top.SHOPADMINDIR+
"index.php?&app=site&ctl=admin_theme_widget&act=do_add_widgets&widgets="+b.name+"&widgets_app="+b.app+"&widgets_theme="+b.theme+"&theme="+c,{modal:!0,title:LANG_shopwidgets.addWidget+(b.label||""),ajaxoptions:{render:!1},width:0.7,height:0.7});this.curDrop=a},editWidget:function(a){var b={modal:!0,title:LANG_shopwidgets.editWidget+(a.label||a.title),ajaksable:!1,width:0.7,height:0.7};this.curWidget=$(a);return a.get("ishtml")?this.curdialog=new top.Dialog(top.SHOPADMINDIR+"index.php?ctl=content/pages&act=editHtml",
Object.merge(b,{ajaksable:!0,ajaxoptions:{method:"post",data:"htmls="+encodeURIComponent(a.getElement(".content-html").get("html").clean().trim())},title:LANG_shopwidgets.editHTML})):this.curdialog=new top.Dialog(top.SHOPADMINDIR+"index.php?app=site&ctl=admin_theme_widget&act=do_edit_widgets&widgets_id="+a.get("widgets_id")+"&theme="+a.get("widgets_theme"),b)},delWidget:function(a){var b=this.drag_operate_box;b.setStyle("visibility","hidden").store("lock",!0);var c=a.getParent();(new Fx.Tween(a)).start("opacity",
0).chain(function(){a.destroy();b.store("lock",!1);this.checkEmptyDropPanel(c);top.document.id("btn_save")&&(top.document.id("btn_save").disabled=!1)}.bind(this))},preview:function(a,b){var c=[],d={};this.drops.each(function(a,b){a.getElements(".shopWidgets_box").each(function(a){c.push("widgets[{widgetsId}]={baseFile}:{baseSlot}:{baseId}".substitute({widgetsId:a.get("widgets_id"),baseFile:this.bf,baseSlot:this.bs,baseId:this.bi}));if(a.get("ishtml")){var b=a.getElement(".content-html");c.push("html[{widgetsId}]={htmls}".substitute({widgetsId:a.get("widgets_id"),
htmls:encodeURIComponent(b.get("html"))}))}},{mce:this.mce,bf:a.get("base_file"),bs:a.get("base_slot"),bi:a.get("base_id")});d[a.get("base_file")]=1}.bind(this));for(f in d)c.push("files[]={file}".substitute({file:f}));(new Request({url:a,method:"post",data:c.join("&"),onRequest:function(){$(b).set({disabled:!0,html:"<span><span>正在生成预览...</span></span>"})},onComplete:function(a){a=JSON.decode(a);$(b).set({disabled:!1,html:"<span><span>预览模板</span></span>"});if(a&&a.success)if(a=$("_temp_preview_link")||
(new Element("a#_temp_preview_link.hide",{target:"preview",href:a.url||top.PREVIEW_URL})).inject(document.body),document.createEvent){var c=document.createEvent("MouseEvent");c.initEvent("click",!1,!1);a.dispatchEvent(c)}else a.click()}})).send()},saveAll:function(a,b){var c=[],d={};this.drops.each(function(a,b){a.getElements(".shopWidgets_box").each(function(a){c.push("widgets[{widgetsId}]={baseFile}:{baseSlot}:{baseId}".substitute({widgetsId:a.get("widgets_id"),baseFile:this.bf,baseSlot:this.bs,
baseId:this.bi}));if(a.get("ishtml")){var b=a.getElement(".content-html");c.push("html[{widgetsId}]={htmls}".substitute({widgetsId:a.get("widgets_id"),htmls:encodeURIComponent(b.get("html"))}))}},{mce:this.mce,bf:a.get("base_file"),bs:a.get("base_slot"),bi:a.get("base_id")});d[a.get("base_file")]=1}.bind(this));for(f in d)c.push("files[]={file}".substitute({file:f}));(new Request({url:top.SHOPADMINDIR+"index.php?app=site&ctl=admin_theme_widget&act=save_all",method:"post",data:c.join("&"),onRequest:function(){new top.MessageBox(LANG_shopwidgets.saving)},
onSuccess:function(c){a&&a.call(b||this,this);try{c=JSON.decode(c);for(dom in c)$(dom)&&c[dom]&&$(dom).set("widgets_id",c[dom]);top.MessageBox.success(LANG_shopwidgets.saveSuccess)}catch(d){top.MessageBox.error(LANG_shopwidgets.saveError+d.message)}}.bind(this)})).send()}});
window.addEvent("domready",function(){this.shopWidgets=new Widgets(".shopWidgets_box",".shopWidgets_panel",{onInit:function(){this.theme=top.THEME_NAME||""},onEdit:function(a,b){shopWidgets.editWidget(a)},onDelete:function(a){top.confirmDialog?top.confirmDialog(LANG_shopwidgets.comfirmDel,function(){this.delWidget(a)}.bind(this)):confirm(LANG_shopwidgets.comfirmDel)&&this.delWidget()},onAdd:function(a,b){var c=this.drag_operate_box,d=b?b.get("class")||"":"";c.store("lock",!0);shopWidgets.widgetsDialog=
new top.Dialog(top.SHOPADMINDIR+"index.php?app=site&ctl=admin_theme_widget&act=add_widgets_page&theme="+this.theme,{width:770,height:500,title:"添加挂件",modal:!0,resizeable:!1,onShow:function(b){this.dialog_body.id="dialogContent";shopWidgets.injectWhere=d;a.hasClass("empty_drop_box")?shopWidgets.injectBox=a.getParent():shopWidgets.injectBox=null},onClose:function(){c.store("lock",!1)}})},onUpDown:function(a,b){top.document.id("btn_save")&&(top.document.id("btn_save").disabled=!1)},onEmptyDrag:function(a){(new Element("div.empty_drag_box",
{html:"(TEMP DATA)"})).inject(a)}})});